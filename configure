#! /bin/bash
# Run this file to recreate the current configuration.

# see
# https://askubuntu.com/questions/674333/how-to-pass-an-array-as-function-argument
# for help on syntax here -- sh is *horrible* syntax
# run a test over a loop
# and return the first that works
# eg
# LS=$(test_cmd which "lss ls")
function test_cmd () {
  declare c="$1"; shift 1 
  rest=("$@")
  for arg in "${rest[@]}";
  do
    if eval $c $arg > /dev/null 2>&1
    then 
      echo $arg
      echo "Type1" $c $arg > /dev/stderr
      return $?
    elif eval $arg $c > /dev/null 2>&1
    then
      echo $arg
      echo "Type1" $arg $c  > /dev/stderr
      return $? 
    else
      echo "Not" $c  $arg > /dev/stderr
    fi
    
  done
  return $?
}

CFLAGSS=("-O" "-O3" "-g")
CCS=("clang" "gcc" "cc")
DYNS=("libtool  -L.. -lc -dynamic -undefined dynamic_lookup" "ld -G")
OPTS=("-fPIC" "-I.")


# specify a temporary directory
TMP=/tmp

ARCH=$(uname -m)
HERE=$(pwd)
BPMS=${BPMS-$HERE}

# fixers
q='\/'
BPMS_=$(echo $BPMS | sed 's/\//Qq/g')
# initialise makefile
sed < $BPMS/src/Makefile.in 's/@BPMS@/'$BPMS_'/' | sed 's/Qq/'$q'/g' | sed 's/@ARCH@/'$ARCH'/' > $BPMS/src/makefile

mkdir -p bin/${ARCH}
PATH=".:bin:bin/${ARCH}:${PATH}"

# create test C code file
echo '#include <stdio.h>' > $TMP/test_$$.c
echo 'int no_main(int argc,char ** argv){printf("hello world\\n");return(1);}' >> $TMP/test_$$.c
echo '' >> $TMP/test_$$.c

##################
# $CC
##################
CC=$(test_cmd "which" "${CCS[@]}")
sed < ${BPMS}/src/makefile 's/@CC@/'"$CC"'/' > $TMP/tmp.$$; mv $TMP/tmp.$$ ${BPMS}/src/makefile

##################
# $CFLAGS
##################
CFLAGS=$(test_cmd "${CC} $TMP/test_$$.c -o $TMP/test_$$.o -c" "${CFLAGSS[@]}")
sed < ${BPMS}/src/makefile 's/@CFLAGS@/'"$CFLAGS"'/' > $TMP/tmp.$$; mv $TMP/tmp.$$ ${BPMS}/src/makefile

################## 
# $OPT
##################
OPT=$(test_cmd "${CC} ${CFLAGS} $TMP/test_$$.c -o $TMP/test_$$.o -c" "${OPTS[@]}")
sed < ${BPMS}/src/makefile 's/@OPT@/'"$OPT"'/' > $TMP/tmp.$$; mv $TMP/tmp.$$ ${BPMS}/src/makefile

##################
# $DYN
##################
DYN=$(test_cmd "-o $TMP/test_$$.so $TMP/test_$$.o" "${DYNS[@]}")
sed < ${BPMS}/src/makefile 's/@DYN@/'"$DYN"'/' > $TMP/tmp.$$; mv $TMP/tmp.$$ ${BPMS}/src/makefile

# tidy up
rm -f $TMP/test_$$.c
exit 0 

